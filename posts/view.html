<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark">
    <meta name="description" content="View post">
    <title>View Post · Modern Blog</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <script defer src="assets/js/main.js"></script>
    <script defer src="assets/js/auth.js"></script>
  </head>
  <body>
    <a class="skip-link" href="#content">Skip to content</a>

    <header class="site-header">
      <nav class="nav container" aria-label="Primary">
        <a class="brand" href="../home.html">ModernBlog</a>
        <button class="nav-toggle" aria-label="Toggle navigation" aria-expanded="false">
          <span class="bar"></span>
          <span class="bar"></span>
          <span class="bar"></span>
        </button>
        <ul class="nav-links">
          <li><a href="../home.html">Home</a></li>
          <li><a href="../about.html">About</a></li>
          <li><a href="../contact.html">Contact</a></li>
          <li><a href="../admin.html">Admin</a></li>
          <li><a href="#" id="logoutLink" style="display:none;">Logout</a></li>
        </ul>
      </nav>
    </header>

    <main id="content" class="container">
      <header class="post-header">
        <h1 id="title">Loading…</h1>
        <div class="meta">
          <time id="date" datetime=""></time>
          <span class="dot" aria-hidden="true">·</span>
          <span><span id="read" class="js-reading-time">—</span> min read</span>
        </div>
      </header>

      <article id="post" class="prose"></article>
    </main>

    <footer class="site-footer">
      <div class="container">
        <p>© <span id="year"></span> ModernBlog. All rights reserved.</p>
      </div>
    </footer>

    <script>
      // Require auth to view posts (await async API)
      (async function(){ if (window.Auth) { const ok = await window.Auth.requireAuth('../index.html'); if (!ok) return; } })();
      (async function () {
        function qs(name) {
          const p = new URLSearchParams(location.search);
          return p.get(name);
        }
        function fmtDateHuman(iso) {
          try { return new Date(iso).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' }); } catch { return iso; }
        }
        function getLocalPost(slug) {
          try {
            const arr = JSON.parse(localStorage.getItem('posts') || '[]');
            return arr.find(p => String(p.slug) === String(slug)) || null;
          } catch {
            return null;
          }
        }
        function renderPost(post) {
          document.title = post.title + ' · Modern Blog';
          document.getElementById('title').textContent = post.title;
          const timeEl = document.getElementById('date');
          timeEl.textContent = fmtDateHuman(post.date || '');
          if (post.date) timeEl.setAttribute('datetime', post.date);
          const article = document.getElementById('post');
          article.innerHTML = post.content;
          try {
            const words = article.innerText.trim().split(/\s+/).length;
            const minutes = Math.max(1, Math.round(words / 200));
            const rtHolder = document.querySelector('.js-reading-time');
            if (rtHolder) { rtHolder.textContent = String(minutes); }
          } catch {}
        }
        const slug = qs('slug');
        if (!slug) { document.getElementById('title').textContent = 'Missing slug'; return; }
        const local = getLocalPost(slug);
        if (local) { renderPost(local); return; }
        try {
          const res = await fetch(`/api/posts/${encodeURIComponent(slug)}`);
          if (!res.ok) throw new Error('Not found');
          const post = await res.json();
          renderPost(post);
        } catch (e) {
          document.getElementById('title').textContent = 'Post not found';
        }
      })();
      (async function(){
        var logout = document.getElementById('logoutLink');
        if (logout && window.Auth && (await window.Auth.isLoggedIn())) {
          logout.style.display = 'inline-block';
          logout.addEventListener('click', function(e){
            e.preventDefault();
            var choice = window.prompt('Type "logout" to sign out, or "delete" to delete your account.');
            if (!choice) return;
            choice = String(choice).toLowerCase().trim();
            if (choice === 'delete') {
              if (window.confirm('Are you sure? This will remove local posts and sign you out.')) {
                if (window.Auth) window.Auth.deleteAccount();
                window.location.replace('../index.html');
              }
            } else if (choice === 'logout') {
              if (window.Auth) window.Auth.logout();
              window.location.replace('../index.html');
            }
          });
        }
      })();
    </script>
  </body>
  
</html>


